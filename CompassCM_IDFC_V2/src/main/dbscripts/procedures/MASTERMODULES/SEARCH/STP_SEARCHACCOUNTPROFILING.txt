CREATE OR REPLACE PROCEDURE STP_SEARCHACCOUNTPROFILING(
i_vcFromDate  IN VARCHAR2, i_vcToDate     IN VARCHAR2,     
i_vcAccountNo IN VARCHAR2, i_vcCustomerId IN VARCHAR2, 
i_vcUserCode  IN VARCHAR2, i_vcGroupCode  IN VARCHAR2,
i_vcIPAddress IN VARCHAR2, io_ResultSet   IN OUT SYS_REFCURSOR
)
-- EXEC STP_SEARCHACCOUNTPROFILING('01/01/2011','01/01/2016','50230300001741','','AMLUser','ROLE_AMLUSER','192.0.0.1',:KG);
AS
  vcSql Varchar2(32000);
BEGIN 

vcSql := ' SELECT ACCOUNTNO PROFILEACCOUNTNO, MAX(CUSTOMERID) CUSTOMERID, MAX(CUSTOMERNAME) CUSTOMERNAME, FUN_DATETOCHAR(MIN(A.ACCT_OPENEDDATE)) ACCT_OPENEDDATE, '||
         '        FUN_DATETOCHAR(MIN(A.TRANSACTIONDATETIME)) TRANSACTIONSTARTDATE, FUN_DATETOCHAR(MAX(A.TRANSACTIONDATETIME)) TRANSACTIONLASTDATE '||
         '   FROM COMAML.TB_ACCOUNTSPROFILEHISTORY A '|| 
         '  WHERE A.TRANSACTIONDATETIME >= FUN_CHARTODATE('''||i_vcFromDate||''') '||
         '    AND A.TRANSACTIONDATETIME <  FUN_CHARTODATE('''||i_vcToDate||''') + 1 '||
         '    AND A.ACCOUNTNO = '''||i_vcAccountNo||''' ';

IF(i_vcCustomerId IS NOT NULL) THEN
  vcSql := vcSql || ' AND A.CUSTOMERID = '''||i_vcCustomerId||''' ';
END IF;

vcSql := vcSql || ' GROUP BY A.ACCOUNTNO, A.ACCT_OPENEDDATE ';

DELETE FROM COMAML.C;
INSERT INTO COMAML.C VALUES(vcSql);
COMMIT;

OPEN io_ResultSet FOR vcSql;

END STP_SEARCHACCOUNTPROFILING;
/
