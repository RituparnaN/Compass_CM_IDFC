CREATE OR REPLACE PROCEDURE STP_SEARCHCUSTREVWEDDETMASTER (
i_vcCustomerId IN VARCHAR2, i_vcUserCode    IN VARCHAR2,
i_vcGroupCode IN VARCHAR2,  i_vcIPAddress   IN VARCHAR2, 
io_cuRESULTSET IN OUT SYS_REFCURSOR
)
-- EXEC STP_SEARCHCUSTREVWEDDETMASTER('','','','',:KG);
AS
  vcQuery VARCHAR2(10000);
  vcCustomerId VARCHAR2(4000) := i_vcCustomerId;

BEGIN
 vcQuery := 'SELECT ROWNUM AS ROWPOSITION, Z.* FROM ( '
         || '    SELECT A.CUSTOMERID, A.SOURCESYSTEM, TO_CHAR(LASTREVIEWEDDATE, ''DD-MON-YYYY'') LASTREVIEWEDDATE, '
         || '           TO_CHAR(UPDATETIMESTAMP, ''DD-MON-YYYY'') UPDATEDON, UPDATEDBY '
	     || '      FROM COMAML.TB_CUSTOMERLASTREVIEWEDDETAILS A'
	     || '     WHERE 1 = 1 ';
	     
IF TRIM(UPPER(i_vcCustomerId)) IS NOT NULL THEN
  vcQuery := vcQuery || ' AND A.CUSTOMERID = '''|| vcCustomerId ||''' ';
END IF;

vcQuery := vcQuery || ' ORDER BY CUSTOMERID ) Z ';
vcQuery := vcQuery || ' WHERE 1 = 1 AND ROWNUM <= 500 ';


DELETE FROM COMAML.C;
INSERT INTO COMAML.C VALUES(vcQuery);
COMMIT;

OPEN io_cuRESULTSET FOR vcQuery;

END STP_SEARCHCUSTREVWEDDETMASTER;
/
