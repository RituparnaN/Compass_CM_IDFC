-- @"C:\Users\Satya prakash\Desktop\Compass_New_Builds_Changes\Dec, 2016\STP_SEARCH_NEPAL_TTRREPORT.txt";

CREATE OR REPLACE PROCEDURE QDE2.STP_SEARCH_NEPAL_TTRREPORT(
i_vcFromDate        IN VARCHAR2, i_vcToDate    IN VARCHAR2,     
i_vcThresholdAmount IN VARCHAR2, i_vcUserCode  IN VARCHAR2, 
i_vcGroupCode       IN VARCHAR2, i_vcIPAddress IN VARCHAR2, 
io_ResultSet        IN OUT SYS_REFCURSOR
)
-- EXEC STP_SEARCH_NEPAL_TTRREPORT('01/01/2011','01/01/2016','10000','AMLUser','ROLE_AMLUSER','192.0.0.1',:KG);
AS
  vcSql      Varchar2(32000);

BEGIN 

  OPEN io_ResultSet FOR
SELECT ROWNUM AS "S.N.", X.* FROM (
SELECT Z."Branch", Z."Date Of Transaction", Z."Nature Of Transaction", 
       Z."Account Type And No.", Z."Amount Involved", Z."Source Of Fund", Z."Remarks"
 FROM (
SELECT CUST.CUSTOMERNAME||' - '||CUST.COMM_ADDRESSLINE1||' - '||CUST.COMM_ADDRESSLINE2||' - '||CUST.COMM_STATE||' - '||COMM_COUNTRY AS "NameAndAddressOfCustomer",
       ACCT.BRANCHCODE||' - '||BRNC.BRANCHNAME AS "Branch",
       TO_CHAR(TXN.TRANSACTIONDATETIME,'DD/MM/YYYY') AS "Date Of Transaction", 
       CASE WHEN TXN.TRANSACTIONTYPE = 'C' AND TXN.DEPOSITORWITHDRAWAL = 'D' THEN 'CASH DEPOSIT'
            WHEN TXN.TRANSACTIONTYPE = 'C' AND TXN.DEPOSITORWITHDRAWAL = 'W' THEN 'CASH WITHDRAWAL'
            WHEN TXN.TRANSACTIONTYPE = 'T' AND TXN.DEPOSITORWITHDRAWAL = 'D' THEN 'INWARD REMITTANCE'
            WHEN TXN.TRANSACTIONTYPE = 'T' AND TXN.DEPOSITORWITHDRAWAL = 'W' THEN 'OUTWARD REMITTANCE'
       ELSE 'Exchange Of Foreign Currency' END AS "Nature Of Transaction",
       CASE WHEN ACCT.ACCOUNTTYPE = 'SBA' THEN 'SAVING ACCOUNT'
            WHEN ACCT.ACCOUNTTYPE = 'CAA' THEN 'CURRENT ACCOUNT'
            WHEN ACCT.ACCOUNTTYPE = 'CCA' THEN 'CASH CREDIT ACCOUNT'
            WHEN ACCT.ACCOUNTTYPE = 'ODA' THEN 'OVERDRAFT ACCOUNT'
       ELSE 'SAVING ACCOUNT' END||' - '||TXN.ACCOUNTNO AS "Account Type And No.",
       TXN.TOTALAMOUNT AS "Amount Involved",
       ACCT.SOURCEOFFUNDS AS "Source Of Fund",
       TXN.DEPOSITORWITHDRAWAL AS "Remarks", 
       TXN.TRANSACTIONDATETIME
  FROM 
(
SELECT A.TRANSACTIONDATETIME, A.ACCOUNTNO, A.CUSTOMERID, SUBSTR(A.TRANSACTIONTYPE,1,1) TRANSACTIONTYPE, A.DEPOSITORWITHDRAWAL,
       SUM(A.AMOUNT * A.CONVERSIONRATE) TOTALAMOUNT
  FROM COMAML.TB_TRANSACTIONS A
 WHERE A.TRANSACTIONDATETIME >= FUN_CHARTODATE(i_vcFromDate)
   AND A.TRANSACTIONDATETIME <  FUN_CHARTODATE(i_vcToDate) + 1
 GROUP BY A.TRANSACTIONDATETIME, A.ACCOUNTNO, A.CUSTOMERID, SUBSTR(A.TRANSACTIONTYPE,1,1), A.DEPOSITORWITHDRAWAL
HAVING SUM(A.AMOUNT * A.CONVERSIONRATE) >= i_vcThresholdAmount
) TXN
LEFT OUTER JOIN COMAML.TB_ACCOUNTSMASTER ACCT ON TXN.ACCOUNTNO = ACCT.ACCOUNTNO
LEFT OUTER JOIN COMAML.TB_BRANCHMASTER BRNC ON ACCT.BRANCHCODE = BRNC.BRANCHCODE
LEFT OUTER JOIN COMAML.TB_CUSTOMERMASTER CUST ON TXN.CUSTOMERID = CUST.CUSTOMERID
)  Z ORDER BY TRANSACTIONDATETIME
)  X;

END STP_SEARCH_NEPAL_TTRREPORT;
/
