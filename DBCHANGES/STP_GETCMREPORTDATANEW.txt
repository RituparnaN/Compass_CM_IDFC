SET DEFINE OFF;

create or replace PROCEDURE "STP_GETCMREPORTDATANEW"
(
  i_vcCompassRefNo  IN VARCHAR2,            i_vcUserCode     IN VARCHAR2,
  i_vcUserRole      IN VARCHAR2,            ipAddress        IN VARCHAR2,
  io_cuResultSet0   IN OUT SYS_REFCURSOR,   io_cuResultSet1  IN OUT SYS_REFCURSOR,
  io_cuResultSet2   IN OUT SYS_REFCURSOR,   io_cuResultSet3  IN OUT SYS_REFCURSOR,
  io_cuResultSet4   IN OUT SYS_REFCURSOR,   io_cuResultSet5  IN OUT SYS_REFCURSOR,
  io_cuResultSet6   IN OUT SYS_REFCURSOR,   io_cuResultSet7  IN OUT SYS_REFCURSOR
)
AS

vcSQL   VARCHAR2(32000);
vcSQL0  VARCHAR2(32000);
vcSQL1  VARCHAR2(32000);
vcSQL2  VARCHAR2(32000);
vcSQL3  VARCHAR2(32000);
vcSQL4  VARCHAR2(32000);
vcSQL5  VARCHAR2(32000);
vcSQL6  VARCHAR2(32000);
vcSQL7  VARCHAR2(32000);

BEGIN

vcSQL0 := 'SELECT ''ASSESSSMENTWISE RISK RATING'' AS TABSNAME FROM DUAL ';

vcSQL1 :=
         'SELECT ROW_NUMBER() OVER (ORDER BY
			CASE 
			WHEN CATEGORY = ''customer'' THEN 1
			WHEN CATEGORY = ''geography'' THEN 2
			WHEN CATEGORY = ''products and services'' THEN 3
			WHEN CATEGORY = ''transactions'' THEN 4
			WHEN CATEGORY = ''delivery channels'' THEN 5
			WHEN CATEGORY = ''Governance 1 Oversight'' THEN 6
			WHEN CATEGORY = ''Customer Due Diligence 1 Management'' THEN 7   
			WHEN CATEGORY = ''Transactions Monitoring'' THEN 8
			WHEN CATEGORY = ''Internal Quality Assurance and Compliance Testing'' THEN 9
			WHEN CATEGORY = ''Name/Sanctions Screening'' THEN 10
			WHEN CATEGORY = ''Training'' THEN 11
			WHEN CATEGORY = ''Foreign Correspondent Banking Relationships'' THEN 12
			WHEN CATEGORY = ''Internal Audit'' THEN 13
			WHEN CATEGORY = ''Reporting Requirements'' THEN 14
			ELSE 15 END) AS SRNO, 
			CATEGORY AS RISK_COMPONENT, 
			FINALRISKRATING AS SCORE,
			(CASE WHEN CATEGORY = ''customer'' THEN ''30%''
			WHEN CATEGORY = ''geography'' THEN ''25%''
			WHEN CATEGORY = ''products and services'' THEN ''25%''
			WHEN CATEGORY = ''transactions'' THEN ''10%''
			WHEN CATEGORY = ''delivery channels'' THEN ''10%''
			WHEN CATEGORY = ''Governance 1 Oversight'' THEN ''10%''
			WHEN CATEGORY = ''Customer Due Diligence 1 Management'' THEN ''25%''   
			WHEN CATEGORY = ''Transactions Monitoring'' THEN ''10%''
			WHEN CATEGORY = ''Internal Quality Assurance and Compliance Testing'' THEN ''10%''
			WHEN CATEGORY = ''Name/Sanctions Screening'' THEN ''10%''
			WHEN CATEGORY = ''Training'' THEN ''15%''
			WHEN CATEGORY = ''Foreign Correspondent Banking Relationships'' THEN ''5%''
			WHEN CATEGORY = ''Internal Audit'' THEN ''10%''
			WHEN CATEGORY = ''Reporting Requirements'' THEN ''5%''
			ELSE ''N.A.'' END) AS WEIGHT,
			(CASE WHEN CATEGORY = ''customer'' THEN FINALRISKRATING*0.30
			WHEN CATEGORY = ''geography'' THEN FINALRISKRATING*0.25
			WHEN CATEGORY = ''products and services'' THEN FINALRISKRATING*0.25
			WHEN CATEGORY = ''transactions'' THEN FINALRISKRATING*0.10
			WHEN CATEGORY = ''delivery channels'' THEN FINALRISKRATING*0.10
			WHEN CATEGORY = ''Governance 1 Oversight'' THEN FINALRISKRATING*0.10
			WHEN CATEGORY = ''Customer Due Diligence 1 Management'' THEN FINALRISKRATING*0.25   
			WHEN CATEGORY = ''Transactions Monitoring'' THEN FINALRISKRATING*0.10
			WHEN CATEGORY = ''Internal Quality Assurance and Compliance Testing'' THEN FINALRISKRATING*0.10
			WHEN CATEGORY = ''Name/Sanctions Screening'' THEN FINALRISKRATING*0.10
			WHEN CATEGORY = ''Training'' THEN FINALRISKRATING*0.15
			WHEN CATEGORY = ''Foreign Correspondent Banking Relationships'' THEN FINALRISKRATING*0.05
			WHEN CATEGORY = ''Internal Audit'' THEN FINALRISKRATING*0.10
			WHEN CATEGORY = ''Reporting Requirements'' THEN FINALRISKRATING*0.05
			ELSE 0.0 END) AS WEIGHTED_SCORE,
			NULL AS TOTAL,
			NULL AS RESULT
		FROM TB_RARISKRATINGS
		WHERE category = subcategory
		AND CMREFNO='''||i_vcCompassRefNo||''' ';

    Open io_cuResultSet0 FOR vcSQL0 ;
    Open io_cuResultSet1 FOR vcSQL1 ;

END STP_GETCMREPORTDATANEW;